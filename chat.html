<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Funmi – AI Assistant</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

<style>
:root {
  --glass-light: rgba(255, 255, 255, 0.55);
  --glass-dark: rgba(30, 30, 30, 0.45);
  --glass-border-light: rgba(255, 255, 255, 0.8);
  --glass-border-dark: rgba(255, 255, 255, 0.18);
  --blur: blur(20px);
  --shadow-light: 0 8px 30px rgba(0,0,0,0.08);
  --shadow-dark: 0 8px 30px rgba(0,0,0,0.4);
}

* { box-sizing: border-box; font-family: 'Inter', sans-serif; }

html, body { height: 100%; margin:0; overflow-x: hidden; }
body {
  background: radial-gradient(circle at center, #ffffff 0%, #f0f0f0 60%, #d8d8d8 100%);
  transition: background 0.4s ease;
}
body.dark { background: radial-gradient(circle at center, #2a2f34 0%, #1f2428 100%); color: #fff; }

/* Sidebar */
.sidebar {
  position: fixed;
  top: 0; left: -260px;
  width: 260px; height: 100vh;
  background: var(--glass-light);
  backdrop-filter: var(--blur);
  border-right: 1px solid var(--glass-border-light);
  border-radius: 0 20px 20px 0;
  padding: 20px;
  transition: left 0.3s ease;
  z-index: 10;
}
body.dark .sidebar { background: var(--glass-dark); border-right: 1px solid var(--glass-border-dark); }
.sidebar.open { left: 0; }
.sidebar h3 { margin-top: 0; }
.chat-session { padding:10px; border-radius:10px; cursor:pointer; margin-bottom:8px; }
.chat-session:hover { background: rgba(255,255,255,0.25); }

/* Top Bar */
.top-bar {
  height: 60px;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 20px; gap:10px;
  position: sticky; top:0; background:transparent; z-index:5;
}

.icon-group { display:flex; gap:10px; }
.icon-btn {
  width: 42px; height: 42px; border-radius:50%;
  background: var(--glass-light);
  backdrop-filter: var(--blur);
  border:1px solid var(--glass-border-light);
  box-shadow: var(--shadow-light);
  display:flex; align-items:center; justify-content:center; cursor:pointer;
}
body.dark .icon-btn { background: var(--glass-dark); border:1px solid var(--glass-border-dark); box-shadow: var(--shadow-dark); color:#fff; }

/* Chat Area */
.chat-area {
  position: absolute;
  top: 60px; bottom: 80px; left:0; right:0;
  padding: 10px;
  overflow-y: auto;
}

/* User Messages */
.message.user {
  max-width: 60%;
  margin-left:auto;
  margin-bottom:12px;
  padding:12px 16px;
  border-radius:16px;
  background: var(--glass-light);
  backdrop-filter: var(--blur);
  border: 1px solid var(--glass-border-light);
  box-shadow: var(--shadow-light);
  overflow-wrap: break-word;
}
body.dark .message.user { background: var(--glass-dark); border:1px solid var(--glass-border-dark); box-shadow: var(--shadow-dark); }

/* AI Messages Sections */
.ai-section {
  width: 100%;
  margin-bottom: 18px;
  padding: 8px 0;
  border-bottom: 1px solid rgba(0,0,0,0.08);
}
body.dark .ai-section { border-bottom: 1px solid rgba(255,255,255,0.15); }

.ai-content {
  padding: 0 5px;
  max-width: 100%;
  overflow-x: hidden;
  word-wrap: break-word;
  white-space: normal;
}

.ai-content img {
  max-width: 100%;
  border-radius: 12px;
  margin: 10px 0;
  cursor: pointer;
}

.ai-content table {
  width: 100%;
  border-collapse: collapse;
  margin: 8px 0;
  display: block;
  overflow-x: auto;
}
.ai-content th, .ai-content td {
  border: 1px solid #444;
  padding: 6px;
  text-align: left;
  white-space: nowrap;
}
.ai-content th {
  background: #222;
  color: #fff;
  font-weight:500;
  text-align:left;
}

.ai-footer {
  display: flex;
  gap: 12px;
  margin-top: 8px;
  font-size: 16px;
}

.ai-footer i {
  cursor: pointer;
  color: #888;
  transition: color 0.2s ease;
}

.ai-footer i:hover { color: #4caf50; }

/* Center Welcome */
.center {
  height: calc(100vh - 160px);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  text-align: center;
}
.logo img { width:80px; margin-bottom:10px; }

/* Input Bar */
.input-bar {
  position: absolute;
  bottom:0; left:0; right:0;
  padding: 20px 15px;
  display:flex; align-items:flex-end; gap:10px;
  background: rgba(255,255,255,0.15);
  backdrop-filter: var(--blur);
}
body.dark .input-bar { background: rgba(0,0,0,0.2); }

.input-wrapper {
  flex:1; display:flex; align-items:center; gap:10px;
  background: var(--glass-light);
  backdrop-filter: var(--blur);
  border:1px solid var(--glass-border-light);
  box-shadow: var(--shadow-light);
  border-radius:18px; padding:10px;
}
body.dark .input-wrapper { background: var(--glass-dark); border:1px solid var(--glass-border-dark); box-shadow: var(--shadow-dark); }

textarea {
  flex:1; width:100%; resize:none; border:none; outline:none;
  background:transparent; font-size:15px; min-height:40px; max-height:220px; color:inherit;
}

.send-btn {
  width:42px; height:42px; border-radius:50%;
  background: var(--glass-light); backdrop-filter: var(--blur);
  border:1px solid var(--glass-border-light);
  display:flex; align-items:center; justify-content:center; cursor:pointer;
  box-shadow: var(--shadow-light);
}
body.dark .send-btn { background: var(--glass-dark); border:1px solid var(--glass-border-dark); box-shadow: var(--shadow-dark); color:#fff; }

/* Mode Indicator */
.mode-indicator {
  position: absolute; bottom: 70px; left:50%;
  transform: translateX(-50%);
  font-size:13px; opacity:0.8;
}

/* Mode Menu */
.mode-menu {
  position:absolute; bottom:80px; right:20px;
  background: var(--glass-light); backdrop-filter: var(--blur);
  border:1px solid var(--glass-border-light); border-radius:14px; padding:10px;
  display:none;
}
body.dark .mode-menu { background: var(--glass-dark); border:1px solid var(--glass-border-dark); }
.mode-menu div { padding:8px 12px; cursor:pointer; border-radius:8px; }
.mode-menu div:hover { background: rgba(255,255,255,0.25); }

/* Image Modal */
.modal {
  position:fixed; inset:0; background:rgba(0,0,0,.85);
  display:none; align-items:center; justify-content:center; z-index:9999;
}
.modal img { max-width:90%; border-radius:12px; }
.modal #modalClose { position:absolute; top:10px; right:10px; color:white; font-size:24px; cursor:pointer; }
.modal #modalDownload { position:absolute; top:10px; right:50px; color:white; font-size:20px; cursor:pointer; }

/* ===============================
   GPT-Style Math / KaTeX Fixes
   =============================== */

/* Inline and display math */
.katex, .katex-display {
  white-space: normal !important;
  word-break: break-word;
  overflow-wrap: anywhere;
  max-width: 100%;
}

/* Display math block spacing */
.katex-display {
  margin: 12px 0;
  padding: 6px 8px;
  overflow-x: auto;
  background: rgba(245,245,245,0.1);
  border-radius: 8px;
}

/* Math color & dark mode */
body.dark .katex-display {
  background: rgba(255,255,255,0.08);
}

/* Example calculation block styling */
.ai-content .example-block {
  background: rgba(0,0,0,0.05);
  border-left: 3px solid #4caf50;
  border-radius: 6px;
  padding: 12px;
  margin: 10px 0;
  font-family: 'Fira Code', monospace;
  white-space: pre-wrap;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

/* Inline code inside examples */
.ai-content .example-block code {
  font-family: 'Fira Code', monospace;
  background: rgba(255,255,255,0.15);
  padding: 2px 4px;
  border-radius: 4px;
}

/* Tables remain scrollable */
.ai-content table {
  display: block;
  overflow-x: auto;
  width: 100%;
}

</style>

<body>
<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <h3>Chats</h3>
  <div class="chat-session">New Chat</div>
  <div class="chat-session">Session 1</div>
</div>

<!-- Top Bar -->
<div class="top-bar">
  <div class="icon-btn" id="menuBtn"><i class="fas fa-bars"></i></div>
  <div class="icon-group">
    <div class="icon-btn" id="themeBtn"><i class="fas fa-moon"></i></div>
    <div class="icon-btn" id="profileBtn"><i class="fas fa-user"></i></div>
  </div>
</div>

<!-- Welcome -->
<div class="center" id="welcome">
  <div class="logo"><img src="uploads/logo2.png" alt="Funmi"></div>
  <h2>Welcome, User</h2>
  <p>What’s today’s task?</p>
</div>

<!-- Chat Area -->
<div class="chat-area" id="chatArea" style="display:none"></div>

<!-- Mode Indicator -->
<div class="mode-indicator" id="modeIndicator">Mode: Default</div>

<!-- Input Bar -->
<div class="input-bar">
  <div class="icon-btn"><i class="fas fa-plus"></i></div>
  <div class="input-wrapper">
    <textarea id="input" placeholder="Ask Funmi..."></textarea>
    <div class="send-btn" id="sendBtn"><i class="fas fa-paper-plane"></i></div>
  </div>
  <div class="icon-btn" id="modeBtn"><i class="fas fa-sliders"></i></div>
</div>

<!-- Mode Menu -->
<div class="mode-menu" id="modeMenu">
  <div data-mode="Default">Default</div>
  <div data-mode="Generate Image">Generate Image</div>
  <div data-mode="Analyze Files">Analyze Files</div>
  <div data-mode="Research">Research</div>
  <div data-mode="Web Search">Web Search</div>
</div>

<!-- Image Modal -->
<div class="modal" id="modal">
  <img id="modalImg">
  <span id="modalClose">✖</span>
  <a id="modalDownload" download>⬇</a>
</div>

<script>
/* ===============================
   DOM Elements & Globals
   =============================== */
const sidebar = document.getElementById('sidebar');
const menuBtn = document.getElementById('menuBtn');
const themeBtn = document.getElementById('themeBtn');
const modeBtn = document.getElementById('modeBtn');
const modeMenu = document.getElementById('modeMenu');
const modeIndicator = document.getElementById('modeIndicator');
const input = document.getElementById('input');
const welcome = document.getElementById('welcome');
const chatArea = document.getElementById('chatArea');
const sendBtn = document.getElementById('sendBtn');
const modal = document.getElementById('modal');
const modalImg = document.getElementById('modalImg');
const modalClose = document.getElementById('modalClose');
const modalDownload = document.getElementById('modalDownload');

const API_URL = 'https://funmi-ure7.onrender.com/api';
let currentMode = 'Default';
let currentSessionId = null;
let loadingMsg = null;

/* ===============================
   UI Controls
   =============================== */
menuBtn.onclick = () => sidebar.classList.toggle('open');
themeBtn.onclick = () => document.body.classList.toggle('dark');
modeBtn.onclick = () => modeMenu.style.display = modeMenu.style.display === 'block' ? 'none' : 'block';
modeMenu.querySelectorAll('div').forEach(item => {
  item.onclick = () => {
    currentMode = item.dataset.mode;
    modeIndicator.textContent = 'Mode: ' + currentMode;
    modeMenu.style.display = 'none';
  };
});
input.addEventListener('input', () => {
  input.style.height = 'auto';
  input.style.height = input.scrollHeight + 'px';
});

/* ===============================
   Markdown Renderer (KaTeX-safe)
   =============================== */
function renderMarkdown(text) {
  // Protect LaTeX blocks
  const latexBlocks = [];
  text = text.replace(/(\$\$[\s\S]+?\$\$|\\\[[\s\S]+?\\\]|\\\([\s\S]+?\\\))/g, m => {
    const key = `@@LATEX${latexBlocks.length}@@`;
    latexBlocks.push(m);
    return key;
  });

  // Code blocks
  text = text.replace(/```([\s\S]*?)```/g, (m, code) => {
    return `<pre><code>${code.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</code></pre>`;
  });

  // Tables
  const tableRegex = /\|(.+)\|\n\|([-\s|:]+)\|\n((\|.*\|\n?)*)/g;
  text = text.replace(tableRegex, match => {
    const lines = match.trim().split('\n');
    const headers = lines[0].split('|').slice(1,-1).map(h => h.trim());
    const rows = lines.slice(2).map(line => line.split('|').slice(1,-1).map(cell => cell.trim()));
    let html = '<div class="table-wrapper"><table><thead><tr>';
    html += headers.map(h => `<th>${h}</th>`).join('');
    html += '</tr></thead><tbody>';
    rows.forEach(row => { html += '<tr>' + row.map(cell => `<td>${cell}</td>`).join('') + '</tr>'; });
    html += '</tbody></table></div>';
    return html;
  });

  // Headings
  text = text.replace(/^### (.*$)/gim,'<h3>$1</h3>')
             .replace(/^## (.*$)/gim,'<h2>$1</h2>')
             .replace(/^# (.*$)/gim,'<h1>$1</h1>');

  // Bold & italics
  text = text.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
             .replace(/\*(?!\s)(.*?)\*/g,'<em>$1</em>');

  // Lists
  text = text.replace(/^- (.*$)/gim,'<li>$1</li>');
  text = text.replace(/(<li>.*<\/li>)/gims,'<ul>$1</ul>');

  // Example blocks
  text = text.replace(/(^\d+\..+(\n.+)*)/gm, '<div class="example-block">$1</div>');

  // Line breaks
  text = text.replace(/\n(?!<\/?(table|thead|tbody|tr|td|th|ul|li|pre|code|div))/g,'<br>');

  // Restore LaTeX
  latexBlocks.forEach((block,i) => text = text.replace(`@@LATEX${i}@@`, block));

  return text;
}

// ====== FINAL AUTO-MATH FIX =======

function autoWrapMath(text) {
  // Clean broken tags
  text = text.replace(/{frac\{4\}\{3\}}/gi, '\\frac{4}{3}');
  text = text.replace(/{frac\{(\d+)\}\{(\d+)\}}/gi, '\\frac{$1}{$2}');
  text = text.replace(/\|pi\|/gi, '\\pi');
  text = text.replace(/\|pi/gi, '\\pi');
  text = text.replace(/pi\|/gi, '\\pi');
  text = text.replace(/r\^3/gi, 'r^3');
  text = text.replace(/r\^2/gi, 'r^2');
  text = text.replace(/\|/g, '');

  // Replace Unicode
  text = text.replace(/π/g, '\\pi');

  // Wrap any line that is a formula (has =)
  text = text.replace(/(\n|^)(\s*)([A-Z]\s*=\s*.+)/gim, '$1$2\\($3\\)');

  return text;
}
/* ===============================
   Helpers
   =============================== */
function scrollDown() { 
  chatArea.scrollTo({ top: chatArea.scrollHeight, behavior: 'smooth' }); 
}

function addUserMessage(text) {
  const msg = document.createElement('div');
  msg.className = 'message user';
  msg.textContent = text;

  let pressTimer;
  msg.addEventListener('mousedown', () => {
    pressTimer = setTimeout(() => {
      navigator.clipboard.writeText(text);
      msg.style.background = '#4caf50';
      setTimeout(() => msg.style.background = '', 500);
    }, 1000);
  });
  msg.addEventListener('mouseup', () => clearTimeout(pressTimer));
  msg.addEventListener('mouseleave', () => clearTimeout(pressTimer));

  chatArea.appendChild(msg);
  scrollDown();
}

/* ===============================
   AI Text (with KaTeX & Footer)
   =============================== */
function addAIText(text) {
  const section = document.createElement('div');
  section.className = 'ai-section';

  const content = document.createElement('div');
  content.className = 'ai-content';

  // ✅ 1. Fix math FIRST (RAW text only)
  const fixedText = autoWrapMath(text);

  // ✅ 2. Then render markdown
  content.innerHTML = renderMarkdown(fixedText);

  section.appendChild(content);
  chatArea.appendChild(section);
  scrollDown();

  // ✅ 3. KaTeX render AFTER DOM insertion
  if (window.renderMathInElement) {
    renderMathInElement(content, {
      delimiters: [
        { left: "\\(", right: "\\)", display: false },
        { left: "\\[", right: "\\]", display: true },
        { left: "$$", right: "$$", display: true }
      ],
      throwOnError: false,
      strict: false
    });
  }

  // ===============================
  // Footer icons (GPT-style)
  // ===============================
  const footer = document.createElement('div');
  footer.className = 'ai-footer';

  const copyIcon = document.createElement('i');
  copyIcon.className = 'fas fa-copy';
  copyIcon.title = 'Copy';
  copyIcon.onclick = () => {
    navigator.clipboard.writeText(text);
    copyIcon.style.color = '#4caf50';
    setTimeout(() => copyIcon.style.color = '#888', 800);
  };

  const thumbsUp = document.createElement('i');
  thumbsUp.className = 'fas fa-thumbs-up';
  thumbsUp.title = 'Helpful';
  thumbsUp.onclick = () => {
    thumbsUp.style.color = '#4caf50';
    thumbsDown.style.color = '#888';
  };

  const thumbsDown = document.createElement('i');
  thumbsDown.className = 'fas fa-thumbs-down';
  thumbsDown.title = 'Not helpful';
  thumbsDown.onclick = () => {
    thumbsDown.style.color = '#f44336';
    thumbsUp.style.color = '#888';
  };

  footer.appendChild(copyIcon);
  footer.appendChild(thumbsUp);
  footer.appendChild(thumbsDown);

  section.appendChild(footer);
}

/* ===============================
   AI Image (with Modal & Footer)
   =============================== */
function addAIImage(src) {
  const section = document.createElement('div');
  section.className = 'ai-section';
  const content = document.createElement('div');
  content.className = 'ai-content';
  const img = document.createElement('img');
  img.src = src;
  img.onclick = () => { 
    modal.style.display = 'flex'; 
    modalImg.src = src; 
    modalDownload.href = src; 
  };
  img.onerror = () => { 
    img.replaceWith(document.createTextNode('⚠ Image failed to load')); 
  };
  content.appendChild(img);
  section.appendChild(content);

  // Footer icons (same as text)
  const footer = document.createElement('div');
  footer.className = 'ai-footer';
  const copyIcon = document.createElement('i'); 
  copyIcon.className = 'fas fa-copy';
  copyIcon.title = 'Copy URL'; 
  copyIcon.onclick = () => { 
    navigator.clipboard.writeText(src); 
    copyIcon.style.color = '#4caf50'; 
    setTimeout(() => copyIcon.style.color = '#888', 800); 
  };
  const thumbsUp = document.createElement('i'); 
  thumbsUp.className = 'fas fa-thumbs-up'; 
  thumbsUp.title = 'Helpful';
  const thumbsDown = document.createElement('i'); 
  thumbsDown.className = 'fas fa-thumbs-down'; 
  thumbsDown.title = 'Not helpful';
  thumbsUp.onclick = () => { thumbsUp.style.color = '#4caf50'; thumbsDown.style.color = '#888'; };
  thumbsDown.onclick = () => { thumbsDown.style.color = '#f44336'; thumbsUp.style.color = '#888'; };
  footer.appendChild(copyIcon); 
  footer.appendChild(thumbsUp); 
  footer.appendChild(thumbsDown);
  section.appendChild(footer);

  chatArea.appendChild(section);
  scrollDown();
}

/* ===============================
   Loading Indicator
   =============================== */
function addLoading() {
  loadingMsg = document.createElement('div');
  loadingMsg.className = 'ai-section';
  const content = document.createElement('div'); 
  content.className = 'ai-content';
  content.textContent = 'Funmi is generating...';
  loadingMsg.appendChild(content);
  chatArea.appendChild(loadingMsg);
  scrollDown();
}
function removeLoading() { 
  if (loadingMsg) { 
    chatArea.removeChild(loadingMsg); 
    loadingMsg = null; 
  } 
}

/* ===============================
   Send Message
   =============================== */
async function sendMessage() {
  const text = input.value.trim(); 
  if (!text) return;
  welcome.style.display = 'none'; 
  chatArea.style.display = 'block';
  addUserMessage(text); 
  input.value = ''; 
  input.style.height = 'auto'; 
  addLoading();

  try {
    if (!currentSessionId) {
      const s = await fetch(`${API_URL}/session`, { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' }, 
        body: JSON.stringify({ sessionName: currentMode }) 
      });
      currentSessionId = (await s.json())._id;
    }

    const res = await fetch(`${API_URL}/message`, { 
      method: 'POST', 
      headers: { 'Content-Type': 'application/json' }, 
      body: JSON.stringify({ sessionId: currentSessionId, message: text, mode: currentMode }) 
    });
    const aiContent = (await res.json()).aiMessage?.content || '';
    removeLoading();

    const isImage = aiContent.startsWith('data:image/') || /^https?:\/\/.*\.(png|jpg|jpeg|webp)$/i.test(aiContent);
    if (currentMode === 'Generate Image' && isImage) {
      addAIImage(aiContent);
    } else {
      addAIText(aiContent);
    }
  } catch (err) {
    removeLoading();
    console.error(err);
    addAIText('⚠ Something went wrong while generating the response.');
  }
}

sendBtn.onclick = sendMessage;
input.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { 
    e.preventDefault(); 
    sendMessage(); 
  }
});
document.addEventListener('click', e => {
  if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) 
    sidebar.classList.remove('open');
});

/* ===============================
   Modal Close
   =============================== */
modalClose.onclick = () => modal.style.display = 'none';
modal.onclick = e => { if (e.target === modal) modal.style.display = 'none'; };

/* ===============================
   Initialize Session & Initial Math Render
   =============================== */
(async function init() {
  try {
    const r = await fetch(`${API_URL}/session`, { 
      method: 'POST', 
      headers: { 'Content-Type': 'application/json' }, 
      body: JSON.stringify({ sessionName: currentMode }) 
    });
    currentSessionId = (await r.json())._id;
  } catch (e) {
    console.error('Session initialization failed', e);
  }
})();

// Initial math render on page load (useful if chat history is added later)
document.addEventListener("DOMContentLoaded", () => {
  if (window.renderMathInElement && chatArea.children.length > 0) {
    renderMathInElement(chatArea, {
      delimiters: [
        { left: "\\(", right: "\\)", display: false },
        { left: "\\[", right: "\\]", display: true },
        { left: "\[ ", right: " \]", display: true }
      ],
      throwOnError: false,
      strict: false
    });
  }
});
</script>
</body>
</html>